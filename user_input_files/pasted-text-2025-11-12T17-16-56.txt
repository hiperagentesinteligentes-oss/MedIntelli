Esse cÃ³digo elimina o erro 500, valida os campos antes do insert, grava o agendamento corretamente no banco e executa o envio automÃ¡tico de confirmaÃ§Ã£o via AVISA API (WhatsApp) â€” mas sem travar o fluxo caso o envio falhe.

ğŸ§© Edge Function completa â€” supabase/functions/agendamentos/index.ts
// ==========================================
// ğŸ“… FUNÃ‡ÃƒO: agendamentos
// Objetivo: criar novo agendamento no Supabase,
// validar dados obrigatÃ³rios e enviar confirmaÃ§Ã£o
// automÃ¡tica via AVISA API / WhatsApp.
// ==========================================

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
};

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { status: 200, headers: corsHeaders });
  }

  const supabase = createClient(
    Deno.env.get("SUPABASE_URL")!,
    Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
  );

  try {
    const body = await req.json();
    const { paciente_id, data_hora, motivo, observacoes, status = "pendente" } = body;

    // ğŸ”’ ValidaÃ§Ã£o dos campos obrigatÃ³rios
    if (!paciente_id || !data_hora) {
      throw new Error("Campos obrigatÃ³rios ausentes: paciente_id e data_hora.");
    }

    // ğŸ” Verifica se o paciente existe
    const { data: paciente, error: pacienteError } = await supabase
      .from("pacientes")
      .select("id, nome, telefone")
      .eq("id", paciente_id)
      .single();

    if (pacienteError || !paciente) {
      throw new Error("Paciente nÃ£o encontrado ou invÃ¡lido.");
    }

    // ğŸ’¾ InserÃ§Ã£o do agendamento
    const { data: novoAgendamento, error: insertError } = await supabase
      .from("agendamentos")
      .insert([
        {
          paciente_id,
          data_hora,
          motivo: motivo || "Consulta",
          observacoes: observacoes || null,
          status,
        },
      ])
      .select()
      .single();

    if (insertError) {
      throw new Error(`Erro ao salvar no banco: ${insertError.message}`);
    }

    // âœ… Tentativa de enviar confirmaÃ§Ã£o via WhatsApp (sem travar)
    try {
      const mensagem = `OlÃ¡ ${paciente.nome}, seu agendamento foi recebido para ${new Date(
        data_hora
      ).toLocaleString("pt-BR", {
        dateStyle: "short",
        timeStyle: "short",
      })}. Aguardamos vocÃª!`;

      const avisaResponse = await fetch("https://api.avisa.com.br/whatsapp/send", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${Deno.env.get("AVISA_API_KEY")}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          to: paciente.telefone,
          template: "confirmacao_agendamento",
          variables: { conteudo: mensagem },
        }),
      });

      const avisaResult = await avisaResponse.json();

      // Grava log da mensagem enviada
      await supabase.from("whatsapp_messages").insert([
        {
          paciente_id,
          categoria: "agenda",
          tipo: "confirmacao_agendamento",
          conteudo: mensagem,
          destinatario_telefone: paciente.telefone,
          status_envio: avisaResponse.ok ? "enviado" : "falhou",
          retorno_api: JSON.stringify(avisaResult),
        },
      ]);
    } catch (msgErr) {
      console.warn("âš ï¸ Falha no envio de mensagem de confirmaÃ§Ã£o:", msgErr.message);
    }

    // âœ… Retorno final
    return new Response(
      JSON.stringify({
        success: true,
        mensagem: "Agendamento criado com sucesso.",
        data: novoAgendamento,
      }),
      { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (error) {
    console.error("âŒ ERRO AO CRIAR AGENDAMENTO:", error);

    return new Response(
      JSON.stringify({
        success: false,
        erro: error.message || "Erro interno no servidor.",
      }),
      { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});

ğŸ§  ExplicaÃ§Ã£o resumida
SeÃ§Ã£o	FunÃ§Ã£o
ğŸ”’ ValidaÃ§Ã£o	Garante que paciente_id e data_hora estejam preenchidos.
ğŸ” VerificaÃ§Ã£o	Confere se o paciente existe antes do insert.
ğŸ’¾ Insert seguro	Cria o agendamento e retorna o registro salvo.
ğŸ“± WhatsApp automÃ¡tico	Envia confirmaÃ§Ã£o via AVISA API (usa AVISA_API_KEY do ambiente).
ğŸªµ Registro de mensagem	Salva log em whatsapp_messages (status: enviado/falhou).
âš™ï¸ Tratamento de erro completo	Nenhum erro interrompe o fluxo â€” tudo Ã© logado.
ğŸ§¾ PrÃ©-requisitos

VariÃ¡veis configuradas no Supabase:

SUPABASE_URL=...
SUPABASE_SERVICE_ROLE_KEY=...
AVISA_API_KEY=...


Tabelas existentes:

pacientes (id, nome, telefone)

agendamentos (id, paciente_id, data_hora, motivo, observacoes, status)

whatsapp_messages (paciente_id, categoria, tipo, conteudo, destinatario_telefone, status_envio, retorno_api)

FunÃ§Ã£o implantada:

supabase functions deploy agendamentos

ğŸ§ª Testar via cURL ou Postman
curl -X POST "https://<projeto>.supabase.co/functions/v1/agendamentos" \
-H "Content-Type: application/json" \
-d '{
  "paciente_id": "uuid-existente",
  "data_hora": "2025-11-13T09:00:00Z",
  "motivo": "Consulta de rotina"
}'


Resposta esperada:

{
  "success": true,
  "mensagem": "Agendamento criado com sucesso.",
  "data": { "id": "...", "status": "pendente" }
}