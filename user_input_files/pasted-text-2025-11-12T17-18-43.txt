Perfeito ‚úÖ Aqui est√° a vers√£o final da fun√ß√£o /agendamentos com logging + alerta autom√°tico via WhatsApp (AVISA API).
Ela faz tudo o que a anterior j√° fazia (valida√ß√£o, insert, log detalhado, envio de confirma√ß√£o) e agora tamb√©m notifica o administrador (voc√™) caso ocorra um erro grave em qualquer etapa.

‚öôÔ∏è SQL ‚Äî Criar/Atualizar tabela de logs
create table if not exists logs_agendamentos (
  id bigint generated by default as identity primary key,
  data timestamp default now(),
  etapa text,
  mensagem text,
  payload jsonb
);

üß© Edge Function: supabase/functions/agendamentos/index.ts
// ==========================================
// üìÖ AGENDAMENTOS (com logging e alerta WhatsApp)
// ==========================================

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
};

// ‚öôÔ∏è N√∫mero do admin que receber√° alertas de erro:
const ADMIN_WHATSAPP = "5516988707777"; // Ex: +55 16 98870-7777

Deno.serve(async (req) => {
  if (req.method === "OPTIONS")
    return new Response(null, { status: 200, headers: corsHeaders });

  const supabase = createClient(
    Deno.env.get("SUPABASE_URL")!,
    Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
  );

  async function log(etapa: string, mensagem: string, payload: any = {}) {
    await supabase.from("logs_agendamentos").insert({ etapa, mensagem, payload });
  }

  async function notificarAdmin(titulo: string, detalhe: string) {
    try {
      await fetch("https://api.avisa.com.br/whatsapp/send", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${Deno.env.get("AVISA_API_KEY")}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          to: ADMIN_WHATSAPP,
          template: "alerta_erro_agendamento",
          variables: { conteudo: `‚ö†Ô∏è ${titulo}\n${detalhe}` },
        }),
      });
    } catch (e) {
      console.warn("‚ö†Ô∏è Falha ao notificar administrador:", e.message);
    }
  }

  try {
    const body = await req.json();
    await log("REQ_RECEBIDA", "Nova solicita√ß√£o de agendamento", body);

    const { paciente_id, data_hora, motivo, observacoes, status = "pendente" } = body;

    if (!paciente_id || !data_hora) {
      await log("ERRO_VALIDACAO", "Campos obrigat√≥rios ausentes", body);
      throw new Error("Campos obrigat√≥rios ausentes: paciente_id e data_hora.");
    }

    const { data: paciente, error: pacienteError } = await supabase
      .from("pacientes")
      .select("id, nome, telefone")
      .eq("id", paciente_id)
      .single();

    if (pacienteError || !paciente) {
      await log("ERRO_PACIENTE", "Paciente n√£o encontrado", { pacienteError });
      throw new Error("Paciente n√£o encontrado ou inv√°lido.");
    }

    const { data: novoAgendamento, error: insertError } = await supabase
      .from("agendamentos")
      .insert([
        {
          paciente_id,
          data_hora,
          motivo: motivo || "Consulta",
          observacoes: observacoes || null,
          status,
        },
      ])
      .select()
      .single();

    if (insertError) {
      await log("ERRO_INSERT", "Falha ao inserir agendamento", { insertError });
      throw new Error(`Erro ao salvar no banco: ${insertError.message}`);
    }

    await log("INSERT_OK", "Agendamento criado com sucesso", novoAgendamento);

    try {
      const mensagem = `Ol√° ${paciente.nome}, seu agendamento foi recebido para ${new Date(
        data_hora
      ).toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" })}.`;

      const avisaResponse = await fetch("https://api.avisa.com.br/whatsapp/send", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${Deno.env.get("AVISA_API_KEY")}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          to: paciente.telefone,
          template: "confirmacao_agendamento",
          variables: { conteudo: mensagem },
        }),
      });

      const avisaResult = await avisaResponse.json();

      await supabase.from("whatsapp_messages").insert([
        {
          paciente_id,
          categoria: "agenda",
          tipo: "confirmacao_agendamento",
          conteudo: mensagem,
          destinatario_telefone: paciente.telefone,
          status_envio: avisaResponse.ok ? "enviado" : "falhou",
          retorno_api: JSON.stringify(avisaResult),
        },
      ]);

      await log("WHATSAPP_ENVIO", "Mensagem de confirma√ß√£o enviada", {
        telefone: paciente.telefone,
        sucesso: avisaResponse.ok,
        retorno: avisaResult,
      });
    } catch (msgErr) {
      await log("ERRO_WHATSAPP", "Falha no envio da mensagem", { msgErr });
      await notificarAdmin("Erro ao enviar mensagem WhatsApp", msgErr.message);
    }

    await log("FINALIZADO", "Fluxo conclu√≠do com sucesso", novoAgendamento);

    return new Response(
      JSON.stringify({
        success: true,
        mensagem: "Agendamento criado com sucesso.",
        data: novoAgendamento,
      }),
      { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (error) {
    await log("ERRO_GERAL", "Falha geral no processo", { erro: error.message });
    await notificarAdmin("Erro geral no agendamento", error.message);
    console.error("‚ùå ERRO AO CRIAR AGENDAMENTO:", error);
    return new Response(
      JSON.stringify({ success: false, erro: error.message }),
      { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});

üì≤ Como funciona o alerta autom√°tico

Qualquer erro (de valida√ß√£o, paciente, insert, WhatsApp, etc.) chama notificarAdmin().

Essa fun√ß√£o envia mensagem via AVISA API para 5516988707777.

O template ‚Äúalerta_erro_agendamento‚Äù deve estar criado na sua conta AVISA (ou use o modo texto direto).

üì® Mensagem recebida (exemplo):

‚ö†Ô∏è Erro geral no agendamento
Campos obrigat√≥rios ausentes: paciente_id e data_hora.

üß† Benef√≠cios

Nenhum erro passa despercebido.

Todos os eventos registrados em logs_agendamentos.

Alertas autom√°ticos no WhatsApp garantem resposta r√°pida.

Continua funcionando mesmo se o envio autom√°tico falhar.