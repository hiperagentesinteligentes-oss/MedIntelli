O pacote j√° cont√©m as Edge Functions e p√°ginas previstas (ex.: supabase/functions/agendamentos, fila-espera, feriados-sync, agent-ia, APIs em src/pages/api/*.ts, telas medintelli-v1/src/pages/AgendaPage.tsx, FeriadosPage.tsx, e no App Paciente app-paciente-medintelli/src/pages/AgendamentosPage.tsx, hooks/useFeriados.ts, al√©m do AuthContext nos dois apps). Abaixo vai um guia de corre√ß√µes finais + checklist de entrega alinhado ao seu ‚ÄúManual de Entrega ‚Äì MedIntelli Basic IA‚Äù, com patches pontuais para acabar com os loops, travamentos e garantir que todas as a√ß√µes funcionem de ponta a ponta (Supabase, OpenAI e WhatsApp/Avisa API).

üîß Corre√ß√µes cr√≠ticas que encontrei (e como finalizar)
1) Looping ap√≥s login (Sistema Principal)

Sinais: logs ‚ÄúBuscando perfil‚Ä¶‚Äù repetindo, tela inicial n√£o finaliza carregamento.
Causa: o AuthContext reexecuta busca de sess√£o/perfil em cascata.

Como finalizar (garantido):

No medintelli-v1/src/contexts/AuthContext.tsx, j√° vi que voc√™s migraram para getSession(). Certifique que:

o efeito roda uma √∫nica vez ([] sem depend√™ncias),

router.replace('/login') s√≥ ocorre quando loading === false && !user,

a p√°gina inicial s√≥ renderiza o conte√∫do quando loading === false.

Se ainda houver loop, adicione um flag local:

let ativo = true;
... // setLoading(true) antes de iniciar
// ao finalizar qualquer ramo, teste `if (ativo) { setLoading(false) }`
return () => { ativo = false; };

2) Travamento ao agendar no App Paciente

Sinais: agendamento trava / ‚ÄúErro ao criar agendamento‚Äù.
Causa: paciente_id ausente ou conflito de hor√°rio, e o POST n√£o faz ‚Äúcadastro r√°pido‚Äù.

Como finalizar (na fun√ß√£o j√° existente):

Em supabase/functions/agendamentos/index.ts garanta:

Cadastro r√°pido quando n√£o houver paciente_id:

if (!paciente_id && paciente_novo?.nome) {
  const { data: novo, error: e1 } = await supabase
    .from('pacientes')
    .insert({
      nome: paciente_novo.nome,
      telefone: paciente_novo.telefone,
      email: paciente_novo.email ?? null,
      convenio: paciente_novo.convenio ?? 'PARTICULAR',
      ativo: true
    })
    .select('id')
    .single();
  if (e1) throw e1;
  paciente_id = novo.id;
}
if (!paciente_id) throw new Error('Informe paciente_id ou paciente_novo');


Conflito de hor√°rio com filtro correto:

const { data: confl } = await supabase
  .from('agendamentos')
  .select('id')
  .or(`and(inicio.lte.${fimISO},fim.gte.${inicioISO})`)
  .neq('status','cancelado')
  .limit(1);
if (confl?.length) return new Response(JSON.stringify({ error: 'Hor√°rio j√° ocupado' }), { status: 409 });


Insert com status: 'pendente' e retorno do id.

No App Paciente (app-paciente-medintelli/src/pages/AgendamentosPage.tsx):

Depois do POST, refetch do hist√≥rico e limpar estado.

Mostrar s√≥ hor√°rios livres (use sua RPC ou select com overlap).

3) Erro ao carregar Feriados (Principal e App)

Sinais: ‚ÄúErro ao sincronizar feriados‚Äù / ‚Äúlooping‚Äù / n√£o aparecem na agenda.
Causas t√≠picas: feriados-sync sem SERVICE_ROLE, RLS impedindo upsert, falta de campos mes/dia_mes/recorrente.

Como finalizar:

Em supabase/functions/feriados-sync/index.ts:

Garanta SUPABASE_SERVICE_ROLE_KEY e createClient com essa key.

No POST (‚ÄúSincronizar Autom√°tico‚Äù):

Upsert calculando mes e dia_mes:

const dia_mes = Number(data.slice(8,10));
const mes = Number(data.slice(5,7));
await supabase.from('feriados').upsert({ data, titulo, recorrente, mes, dia_mes }, { onConflict: 'data' });


Em medintelli-v1/src/pages/FeriadosPage.tsx:

Trate erros com toast/alert e mostre vazio amig√°vel quando n√£o houver registros.

No calend√°rio (Agenda), destaque:

feriado recorrente quando mes/dia_mes coincidir,

feriado n√£o recorrente quando data for o dia consultado.

4) Lista de Espera n√£o lista/salva

Sinais: GET vazio / POST falha / n√£o sugere paciente novo.
Como finalizar (a fun√ß√£o fila-espera j√° existe no pacote):

Em supabase/functions/fila-espera/index.ts:

No GET: sempre traga join com paciente e (opcional) agendamento.

const { data } = await supabase
  .from('fila_espera')
  .select('*, paciente:pacientes(id,nome,telefone), agendamento:agendamentos(id,inicio,status)')
  .order('pos', { ascending: true })
  .order('created_at', { ascending: true });


No POST: aceite paciente_id ou paciente_novo (cadastro r√°pido igual ao de agendamento).

No Front da fila:

Permita arrastar‚Üë‚Üì (voc√™ j√° tem base DnD): persistir pos via PATCH com array {id, pos}.

Bot√£o AGENDAR a partir da fila: sugerir 3 op√ß√µes livres e, ao clicar, confirmar (insere em agendamentos, remove da fila).

5) Agenda n√£o mostra itens nas 3 vis√µes

Causa: range de datas incorreto e/ou filtro de status muito restritivo.
Como finalizar:

Em supabase/functions/agendamentos/index.ts no GET:

Receba scope (day|week|month), start e end (ISO) e use gte('inicio', start).lt('fim', end).

Inclua pendente e confirmado:

.in('status', ['pendente','confirmado'])


Em medintelli-v1/src/pages/AgendaPage.tsx:

Adicione input <input type="date"> para mudar o dia base e compute o range do m√™s/semana/dia.

Ap√≥s cada opera√ß√£o (criar/cancelar/alterar), fa√ßa loadAgenda().

6) Painel de Mensagens (App/WhatsApp)

Sinais: looping ‚ÄúCarregando mensagens‚Ä¶‚Äù, sem contagens, sem paciente, sem encaminhar.
Como finalizar:

Efeito sem depend√™ncia circular:

useEffect(()=>{ let alive=true; load(); const id=setInterval(load, 15000);
  return ()=>{alive=false; clearInterval(id)}; }, []);


Dois bot√µes para trocar consulta: App Paciente (tabela app_messages) e WhatsApp (whatsapp_messages).

Mostrar paciente.nome (inclua join no select).

Badges com n√£o lidas (vistas vw_unread_app e vw_unread_whats).

Encaminhar: select com m√©dicos; default = Dr. Francisco; grava encaminhamento e some da ‚Äúpendente‚Äù.

7) Conv√™nios + ‚ÄúPARTICULAR‚Äù e Tipos de consulta

Em Pacientes, o select de conv√™nio deve conter:

UNIMED, UNIMED UNIF√ÅCIL, CASSI, CABESP, PARTICULAR.

Em Agendamento, o select ‚ÄúTipo de consulta‚Äù deve ler de tipos_consulta (j√° h√° migrations no pacote).

8) WhatsApp (Avisa API) ‚Äî restri√ß√£o de testes

Obrigat√≥rio: nas fun√ß√µes whatsapp-webhook-receiver e whatsapp-send-message, valide o n√∫mero de testes: somente +55 16 988707777 durante os testes autom√°ticos.
Se vier outro, n√£o envie e logue um aviso (evita envios inadvertidos).

‚úÖ Checklist de Entrega (casado com o seu Manual)

Antes de come√ßar, aplique migrations e garanta .env:

SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, NEXT_PUBLIC_SUPABASE_ANON_KEY

OPENAI_API_KEY, OPENAI_MODEL=gpt-4-turbo

AVISA_API_URL, AVISA_API_KEY

BASE_KNOWLEDGE_PATH=./knowledge/base_conhecimento.txt

1¬™ Etapa
(1) Cadastro de Usu√°rios e Perfis

Seed (ou p√°gina Usu√°rios) com:

Alencar (ADMIN), Silvia (ADMIN), Gabriel (Auxiliar), Natashia (Secret√°ria), Dr. Francisco (M√©dico).

Valida√ß√£o: todos entram e veem o que seu perfil permite.
(Se quiser, incluo uma fun√ß√£o seed-users ‚Äî j√° existe supabase/functions/seed-users/ no pacote.)

(2) Pacientes

CRUD completo em Pacientes:

cadastrar 20 pacientes,

alterar telefone de 3,

conv√™nio inclui PARTICULAR,

ativar/inativar funciona sem apagar.

(3) Feriados

Cadastrar municipais,

Sincronizar nacionais,

Exibir na Agenda (Principal e App). Dias de feriado aparecem indispon√≠veis no App.

(4) Agenda ‚Äì Cadastro Manual

5 agendamentos de pacientes j√° cadastrados,

3 agendamentos de pacientes n√£o cadastrados (via cadastro r√°pido do modal),

2 cancelamentos,

2 altera√ß√µes de data/hor√°rio,

Duplo agendamento no mesmo hor√°rio entre paciente cadastrado e novo ‚Üí deve bloquear com 409 ‚ÄúHor√°rio j√° ocupado‚Äù,

Itens aparecem nas vis√µes m√™s/semana/dia,

App Paciente n√£o lista hor√°rios ocupados.

(5) Lista de Espera ‚Äì Cadastro Manual

5 pacientes novos + 3 cadastrados,

Alterar telefone de 3,

Ordenar por arrastar, e modo ‚Äúchegada‚Äù ou ‚Äúprioridade‚Äù.

2¬™ Etapa
(6) Mensagem manual pelo Sistema (WhatsApp/App)

Enviar testando v√°rias situa√ß√µes; IA responde usando Base √önica de Conhecimento (arquivo .txt).

Somente n√∫mero de teste permitido nos autom√°ticos: 16 988707777.

(7) Mensagem simulando Paciente

3 pacientes conversam (App + WhatsApp).

Painel do sistema mostra as conversas, sem loop, com paciente identificado.

(8) Encaminhar para Dr. Francisco

5 encaminhamentos ‚Üí aparecem como pendentes no m√©dico e, ao finalizar, movem para hist√≥rico.

(9) Agendamento via WhatsApp/App

5 agendamentos criados pela IA ‚Üí Agenda Principal e App mostram os mesmos itens.

üß© Patches que eu recomendo colar agora (copiar/colar)

Agendamentos (Edge) ‚Äî cadastro r√°pido + conflito + range
(Como acima, dentro do POST e GET de supabase/functions/agendamentos/index.ts)

Fila de Espera (Edge) ‚Äî GET com joins + POST com paciente_novo
(Como acima, em supabase/functions/fila-espera/index.ts)

Feriados (Edge) ‚Äî sincronizar com upsert recorrente
(Como acima, em supabase/functions/feriados-sync/index.ts)

Painel de Mensagens (Front) ‚Äî efeito sem loop e ‚Äúvazio amig√°vel‚Äù

useEffect(()=>{
  let alive=true; const ctrl=new AbortController();
  async function load(){
    setLoading(true);
    try{
      const r=await fetch(`/api/mensagens?fonte=${fonte}`,{signal:ctrl.signal});
      const j=await r.json();
      if(!alive) return; setMensagens(j.data||[]);
    } finally{
      if(alive) setLoading(false);
    }
  }
  load(); const id=setInterval(load,15000);
  return ()=>{alive=false; ctrl.abort(); clearInterval(id);}
},[fonte]); // fonte = 'app' | 'whatsapp'


Agenda (Front) ‚Äî seletor de data + faixas corretas + refetch ap√≥s a√ß√µes

M√™s: primeiro/√∫ltimo dia (00:00 ‚Üí 23:59:59).

Semana: segunda ‚Üí domingo.

Dia: 00:00 ‚Üí 23:59:59.

Sempre chamar loadAgenda() ap√≥s inserir/cancelar/editar.

Auth (Front) ‚Äî evitar loop

getSession() no AuthContext, uma vez, marcar loading=false sempre (try/finally) e s√≥ redirecionar quando !user && !loading.

WhatsApp (Edge) ‚Äî whitelist de n√∫mero no teste

const allowed = ['+5516988707777','16988707777','16 988707777'];
if (!allowed.some(v => telefone.includes(v))) {
  console.log('Mensagem bloqueada em ambiente de teste', telefone);
  return ok();
}

‚ö†Ô∏è Depend√™ncias externas (pontos de aten√ß√£o)

WhatsApp / Avisa API: √© indispens√°vel que a URL de webhook p√∫blica esteja ativa e as credenciais (AVISA_API_URL, AVISA_API_KEY) estejam corretas. Sem isso, os testes do item 6‚Äì9 funcionam s√≥ no App; no WhatsApp real dependem do Avisa.

OpenAI: a .env precisa da chave v√°lida, e a Base √önica de Conhecimento (./knowledge/base_conhecimento.txt) deve existir e ser leg√≠vel pelo runtime (Edge que l√™ via Deno FS ou carregar via Supabase Storage).

RLS: se estiver ativo, as Edge Functions devem usar SERVICE_ROLE para bypass; sen√£o, ajuste policies para permitir inserts/updates esperados.