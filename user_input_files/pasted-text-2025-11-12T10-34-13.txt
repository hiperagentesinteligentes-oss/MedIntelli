ğŸ§© INSTRUÃ‡ÃƒO DEFINITIVA â€“ CORREÃ‡ÃƒO FINAL DO SISTEMA MEDINTELLI BASIC IA

ğŸ“… VersÃ£o 1.0-Final | Status: CorreÃ§Ã£o estrutural e estabilizaÃ§Ã£o backend

âš ï¸ 1ï¸âƒ£ RESUMO DOS PROBLEMAS REAIS (AINDA EXISTENTES)
MÃ³dulo	Erro	Causa raiz
Agenda	500	Edge Function agendamentos quebrada (falha de parÃ¢metro ou relacionamento)
Pacientes	SessÃ£o expirada	API chamando Supabase diretamente sem proxy + token invÃ¡lido
Fila de Espera	500	Edge Function fila-espera sem retorno JSON correto ou conflito em tabela
Mensagens	404	Tabelas mensagens_app, whatsapp_messages e profissionais inexistentes
WhatsApp	400 (QR invÃ¡lido)	Chave Avisa API incorreta ou QR expirando antes de handshake
UsuÃ¡rios	SessÃ£o expirada ao salvar	API nÃ£o estÃ¡ usando SERVICE_ROLE_KEY nas rotas Next.js
ğŸ§± 2ï¸âƒ£ OBJETIVO DESTA ETAPA

Eliminar TODOS os erros de backend (500/400/404) e de sessÃ£o expirada, garantindo que todas as Edge Functions, tabelas e APIs estejam 100% sincronizadas.

O sistema jÃ¡ estÃ¡ visualmente completo â€” o problema agora Ã© estrutural: Supabase + AutenticaÃ§Ã£o + Edge Functions.

ğŸ”§ 3ï¸âƒ£ CORREÃ‡Ã•ES OBRIGATÃ“RIAS (PASSO A PASSO)
ğŸ”¹ 3.1 â€“ Edge Function agendamentos

Abrir supabase/functions/agendamentos/index.ts e substituir por este cÃ³digo validado:

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  Deno.env.get("SUPABASE_URL")!,
  Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
);

Deno.serve(async (req) => {
  try {
    const url = new URL(req.url);
    const method = req.method;

    if (method === "GET") {
      const start = url.searchParams.get("start");
      const end = url.searchParams.get("end");
      if (!start || !end) throw new Error("start e end sÃ£o obrigatÃ³rios.");

      const { data, error } = await supabase
        .from("agendamentos")
        .select("id, inicio, fim, status, paciente_id, pacientes (nome)")
        .gte("inicio", start)
        .lt("fim", end)
        .order("inicio", { ascending: true });

      if (error) throw error;
      return new Response(JSON.stringify({ data }), { status: 200 });
    }

    if (method === "POST") {
      const body = await req.json();
      const { paciente_id, inicio, fim } = body;
      if (!paciente_id || !inicio || !fim) throw new Error("Campos obrigatÃ³rios ausentes.");

      const { data, error } = await supabase
        .from("agendamentos")
        .insert(body)
        .select()
        .single();

      if (error) throw error;
      return new Response(JSON.stringify({ data }), { status: 201 });
    }

    return new Response("MÃ©todo nÃ£o suportado", { status: 405 });
  } catch (err) {
    return new Response(JSON.stringify({ error: err.message }), { status: 500 });
  }
});


âœ… CorreÃ§Ã£o: tratamento de erro uniforme + parÃ¢metros obrigatÃ³rios + retorno JSON vÃ¡lido.
âœ… Resultado esperado: eliminar os 500 em /agendamentos.

ğŸ”¹ 3.2 â€“ Edge Function fila-espera
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(
  Deno.env.get("SUPABASE_URL")!,
  Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
);

Deno.serve(async (req) => {
  try {
    if (req.method === "GET") {
      const { data, error } = await supabase
        .from("fila_espera")
        .select("id, paciente_id, status, pacientes (nome)")
        .order("created_at", { ascending: true });
      if (error) throw error;
      return new Response(JSON.stringify({ data }), { status: 200 });
    }

    if (req.method === "POST") {
      const body = await req.json();
      const { paciente_id } = body;
      if (!paciente_id) throw new Error("Paciente obrigatÃ³rio.");

      const { data, error } = await supabase
        .from("fila_espera")
        .insert(body)
        .select()
        .single();
      if (error) throw error;
      return new Response(JSON.stringify({ data }), { status: 201 });
    }

    return new Response("MÃ©todo nÃ£o suportado", { status: 405 });
  } catch (e) {
    return new Response(JSON.stringify({ error: e.message }), { status: 500 });
  }
});


âœ… CorreÃ§Ã£o: corrige os 500 da Fila de Espera.

ğŸ”¹ 3.3 â€“ Recriar tabelas ausentes

Executar no SQL Editor do Supabase:

-- PROFISSIONAIS
create table if not exists profissionais (
  id uuid primary key default uuid_generate_v4(),
  nome text not null,
  especialidade text,
  tipo text default 'medico'
);

-- MENSAGENS_APP
create table if not exists mensagens_app (
  id uuid primary key default uuid_generate_v4(),
  paciente_id uuid references pacientes(id) on delete cascade,
  conteudo text not null,
  lida boolean default false,
  created_at timestamp default now()
);

-- WHATSAPP_MESSAGES
create table if not exists whatsapp_messages (
  id uuid primary key default uuid_generate_v4(),
  telefone text,
  mensagem text,
  lida boolean default false,
  encaminhamento text,
  created_at timestamp default now()
);


âœ… Corrige os 404 em mensagens_app, whatsapp_messages e profissionais.

ğŸ”¹ 3.4 â€“ SessÃ£o expirada

Ajustar todas as chamadas fetch() do front para irem via /api/ e nÃ£o diretamente ao Supabase.

No arquivo /pages/api/agendamentos.ts e similares:

export default async function handler(req, res) {
  const url = `${process.env.NEXT_PUBLIC_SUPABASE_URL}/functions/v1/agendamentos`;
  const r = await fetch(url, {
    method: req.method,
    headers: {
      "Authorization": `Bearer ${process.env.SUPABASE_SERVICE_ROLE_KEY}`,
      "Content-Type": "application/json",
    },
    body: ["GET","DELETE"].includes(req.method) ? undefined : JSON.stringify(req.body),
  });
  const data = await r.json().catch(() => ({}));
  res.status(r.status).json(data);
}


âœ… Isso elimina o erro â€œSessÃ£o expiradaâ€.

ğŸ”¹ 3.5 â€“ QR Code Avisa API

Verificar se o token AVISA_API_KEY corresponde ao mesmo nÃºmero do WhatsApp configurado.

Regenerar QR via painel da Avisa (/instances) e atualizar em .env:

AVISA_INSTANCE_ID=xxxxxxxx
AVISA_API_KEY=yyyyyyyy


Validar o webhook no painel da Avisa:

https://2m72mamv4exw.space.minimax.io/api/whatsapp-webhook


Executar um curl:

curl -X GET https://2m72mamv4exw.space.minimax.io/api/whatsapp-status


Se o retorno for instance connected: true, o QR estÃ¡ correto.

âœ… Corrige QR invÃ¡lido.

ğŸ”¹ 3.6 â€“ Ajuste geral de polÃ­ticas Supabase (RLS)

Executar no SQL Editor:

alter table pacientes disable row level security;
alter table agendamentos disable row level security;
alter table fila_espera disable row level security;
alter table mensagens_app disable row level security;
alter table whatsapp_messages disable row level security;
alter table profissionais disable row level security;

ğŸ§ª 4ï¸âƒ£ TESTES AUTOMÃTICOS PÃ“S-CORREÃ‡ÃƒO

âœ… Acessar /dashboard como Alencar e abrir Agenda â†’ Nenhum erro 500.
âœ… Criar paciente â†’ sem â€œSessÃ£o expiradaâ€.
âœ… Abrir Fila de Espera â†’ lista carregada.
âœ… Painel de Mensagens â†’ carrega App e WhatsApp sem 404.
âœ… Enviar mensagem â†’ aparece no painel.
âœ… Acessar QR Avisa â†’ status connected: true.

ğŸ“‹ 5ï¸âƒ£ RESULTADO ESPERADO FINAL
MÃ³dulo	Status esperado
Agenda	âœ… Carrega sem 500
Pacientes	âœ… CRUD sem SessÃ£o expirada
Fila de Espera	âœ… Lista e insere normalmente
Mensagens	âœ… Sem 404, carregando dados
WhatsApp	âœ… QR vÃ¡lido e IA respondendo
UsuÃ¡rios	âœ… Salva e atualiza corretamente
ğŸ§  6ï¸âƒ£ RECAP .ENV (checar tudo)
SUPABASE_URL=https://ufxdewolfdpgrxdkvnbr.supabase.co
SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
AVISA_API_KEY=
AVISA_INSTANCE_ID=
AVISA_API_URL=https://app.avisa.ai/api
OPENAI_API_KEY=
BASE_KNOWLEDGE_PATH=./knowledge/base_conhecimento.txt
TZ=America/Sao_Paulo

âœ… 7ï¸âƒ£ MENSAGEM FINAL PARA O MINIMAX

Execute todas as correÃ§Ãµes acima exatamente nessa ordem.
Valide cada mÃ³dulo com os logins fornecidos e capture screenshots dos resultados:

Agenda (sem erro 500)

Fila de Espera carregando

Painel de Mensagens com dados

QR Code ativo e IA respondendo via WhatsApp