agora vamos orientar o MiniMax de forma completa e precisa, para que ele:
‚úÖ configure o OpenAI corretamente (com sua chave),
‚úÖ utilize uma Base √önica de Conhecimento (BUC),
‚úÖ gere respostas inteligentes e coerentes no WhatsApp e no App Paciente,
‚úÖ e execute a√ß√µes no sistema (agendar, cancelar, enviar exame, responder d√∫vidas).

Abaixo segue o roteiro final pronto para o MiniMax, para colar e executar diretamente.

üß† ORIENTA√á√ÉO PARA O MINIMAX
üí¨ INTEGRA√á√ÉO OPENAI + BASE DE CONHECIMENTO
(WhatsApp + App Paciente + Sistema Principal)
üéØ OBJETIVO GERAL

Implementar um Agente de IA Cl√≠nico Inteligente, capaz de:

Responder automaticamente √†s mensagens dos pacientes via WhatsApp (Avisa API) e Chat do App Paciente;

Ler e utilizar a Base √önica de Conhecimento (BUC) para elaborar respostas precisas e humanizadas;

Reconhecer inten√ß√µes (agendamento, cancelamento, exames, orienta√ß√µes m√©dicas, d√∫vidas gerais);

Executar a√ß√µes autom√°ticas no sistema (registrar agendamento, enviar exame ao painel, adicionar paciente √† fila de espera);

Atualizar registros no Supabase e registrar o hist√≥rico completo da conversa.

‚öôÔ∏è 1Ô∏è‚É£ CONFIGURA√á√ÉO DO OPENAI
Vari√°veis obrigat√≥rias no .env:
OPENAI_API_KEY=chave_real_da_openai
OPENAI_MODEL=gpt-4-turbo
BASE_KNOWLEDGE_PATH=/knowledge/base_conhecimento.txt

Biblioteca de conex√£o (src/lib/openai.ts):
import OpenAI from "openai";
import fs from "fs";

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY!,
});

export async function gerarRespostaIA(mensagem: string, contexto: string) {
  try {
    const prompt = `
Voc√™ √© um assistente m√©dico digital da cl√≠nica MedIntelli. 
Responda de forma educada, coerente e assertiva, usando linguagem natural e profissional.
Use as informa√ß√µes da BASE DE CONHECIMENTO abaixo e oriente o paciente com clareza.

--- BASE DE CONHECIMENTO ---
${contexto}

--- MENSAGEM DO PACIENTE ---
${mensagem}

Se identificar inten√ß√£o de AGENDAMENTO, CANCELAMENTO ou EXAMES:
- Retorne um JSON com a estrutura:
{
  "tipo": "agendamento|cancelamento|exame|informacao",
  "mensagem": "resposta textual ao paciente",
  "acao": {
    "tabela": "agendamentos|fila_espera|exames",
    "dados": {...}
  }
}
Caso contr√°rio, retorne apenas a resposta textual.
    `;

    const completion = await client.chat.completions.create({
      model: process.env.OPENAI_MODEL || "gpt-4-turbo",
      messages: [{ role: "user", content: prompt }],
      temperature: 0.4,
    });

    return completion.choices[0].message?.content;
  } catch (error) {
    console.error("Erro ao gerar resposta IA:", error);
    return "Desculpe, estou com dificuldade para processar agora. Tente novamente em instantes.";
  }
}

export async function carregarBaseConhecimento(): Promise<string> {
  try {
    const caminho = process.env.BASE_KNOWLEDGE_PATH || "./knowledge/base_conhecimento.txt";
    return fs.existsSync(caminho) ? fs.readFileSync(caminho, "utf-8") : "";
  } catch (error) {
    console.error("Erro ao carregar base de conhecimento:", error);
    return "";
  }
}

üìÅ 2Ô∏è‚É£ BASE √öNICA DE CONHECIMENTO (BUC)

Crie a pasta:

/knowledge/base_conhecimento.txt


E coloque o conte√∫do inicial (exemplo):

BASE DE CONHECIMENTO - CL√çNICA MEDINTELLI

1. A cl√≠nica MedIntelli realiza atendimentos nas √°reas de neurologia, psiquiatria e cl√≠nica geral.
2. O hor√°rio de funcionamento √© de segunda a sexta, das 8h √†s 18h.
3. O paciente pode agendar, remarcar ou cancelar consultas pelo App Paciente ou WhatsApp.
4. Em caso de emerg√™ncia, o paciente deve procurar atendimento hospitalar imediato.
5. O prazo m√©dio para retorno de exame √© de 3 dias √∫teis.
6. A secret√°ria Silvia pode confirmar hor√°rios e reagendar consultas.
7. Pacientes novos precisam informar nome completo, telefone, e data de nascimento.
8. A IA pode auxiliar no pr√©-agendamento, mas a confirma√ß√£o final √© feita pela equipe.


O arquivo deve ser atualizado periodicamente pelo administrador ou m√©dico, e a IA sempre usar√° o conte√∫do mais recente.

üîÑ 3Ô∏è‚É£ FUN√á√ÉO DE PROCESSAMENTO INTELIGENTE
(Edge Function: /supabase/functions/agent-ia/index.ts)
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import { gerarRespostaIA, carregarBaseConhecimento } from "./lib/openai.ts";

Deno.serve(async (req) => {
  const supabase = createClient(
    Deno.env.get("SUPABASE_URL")!,
    Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
  );

  try {
    const { mensagem, paciente_id, origem } = await req.json();
    if (!mensagem) throw new Error("Mensagem ausente.");

    const contexto = await carregarBaseConhecimento();
    const resposta = await gerarRespostaIA(mensagem, contexto);

    // Grava resposta no hist√≥rico
    await supabase.from("whatsapp_messages").insert({
      paciente_id,
      origem: origem || "app",
      mensagem: resposta,
      tipo: "resposta",
      data_envio: new Date().toISOString(),
    });

    return new Response(JSON.stringify({ ok: true, resposta }), { status: 200 });
  } catch (error) {
    console.error("Erro no agente IA:", error);
    return new Response(JSON.stringify({ ok: false, error: error.message }), { status: 400 });
  }
});

üì± 4Ô∏è‚É£ CHAT APP PACIENTE (Front)

Ao enviar mensagem:

async function handleEnviarMensagem() {
  const body = {
    mensagem: novaMensagem,
    paciente_id: user.id,
    origem: "app",
  };

  const res = await fetch("/api/agent-ia", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
  });

  const j = await res.json();
  if (j.ok) {
    setMensagens([...mensagens, { autor: "paciente", texto: novaMensagem }]);
    setMensagens((prev) => [...prev, { autor: "ia", texto: j.resposta }]);
    setNovaMensagem("");
  } else {
    alert("Erro: " + j.error);
  }
}

üí¨ 5Ô∏è‚É£ WHATSAPP (Avisa API + IA)

No webhook whatsapp-webhook-receiver:

// Ap√≥s receber mensagem do paciente
if (mensagem.tipo === "texto") {
  const contexto = await carregarBaseConhecimento();
  const resposta = await gerarRespostaIA(mensagem.texto, contexto);

  // Enviar resposta via Avisa API
  await fetch(`${Deno.env.get("AVISA_API_URL")}/messages/send`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${Deno.env.get("AVISA_API_KEY")}` },
    body: JSON.stringify({
      telefone: mensagem.telefone,
      mensagem: resposta,
    }),
  });

  // Registrar mensagem no banco
  await supabase.from("whatsapp_messages").insert({
    paciente_id: paciente.id,
    origem: "whatsapp",
    mensagem: resposta,
    tipo: "resposta",
  });
}

üìä 6Ô∏è‚É£ DASHBOARD INTELIGENTE

No Sistema Principal, incluir um Painel de Mensagens com IA:

Exibir mensagens dos pacientes e respostas autom√°ticas da IA;

Bot√£o ‚ÄúRevisar e reenviar resposta‚Äù (para humanos corrigirem respostas da IA, se necess√°rio);

Mostrar √≠cone üß† nas respostas autom√°ticas;

Indicar quando a IA executou uma a√ß√£o autom√°tica (ex: criou agendamento).

‚úÖ RESULTADO FINAL

Paciente envia mensagem ‚Üí IA responde com empatia e informa√ß√£o real da BUC;

IA pode agendar, cancelar, enviar exames ou orientar procedimentos;

Todas as mensagens ficam registradas no painel do Sistema Principal;

Equipe pode revisar e reenviar, mantendo hist√≥rico completo;

Base de conhecimento centralizada e edit√°vel em um √∫nico arquivo.