roteiro tÃ©cnico consolidado e completo, que vocÃª pode copiar e colar diretamente no MiniMax â€” ele abrange:
1ï¸âƒ£ A integraÃ§Ã£o OpenAI com Base Ãšnica de Conhecimento,
2ï¸âƒ£ A funÃ§Ã£o Pacientes (busca, cadastro, ediÃ§Ã£o, exclusÃ£o, ativar/inativar e convÃªnios validados),
3ï¸âƒ£ E a correÃ§Ã£o do looping no Painel de Mensagens (App Paciente e WhatsApp).

ğŸ§  ORIENTAÃ‡ÃƒO COMPLETA PARA O MINIMAX
ğŸ”§ SISTEMA PRINCIPAL + APP PACIENTE + OPENAI + SUPABASE
VersÃ£o 2.0 â€” CorreÃ§Ãµes e ExpansÃµes Funcionais
ğŸ§© 1ï¸âƒ£ INTEGRAÃ‡ÃƒO COM OPENAI E BASE DE CONHECIMENTO
OBJETIVO

Implementar respostas inteligentes e automÃ¡ticas no WhatsApp e App Paciente, utilizando:

Modelo GPT-4-Turbo (via OpenAI API),

Base Ãšnica de Conhecimento (BUC) centralizada,

E aÃ§Ãµes automÃ¡ticas (agendar, cancelar, responder exames).

VARIÃVEIS OBRIGATÃ“RIAS .env
OPENAI_API_KEY=colocar_sua_chave_aqui
OPENAI_MODEL=gpt-4-turbo
BASE_KNOWLEDGE_PATH=./knowledge/base_conhecimento.txt

ESTRUTURA DE ARQUIVOS
src/lib/openai.ts
supabase/functions/agent-ia/index.ts
knowledge/base_conhecimento.txt

ğŸ“˜ /src/lib/openai.ts
import OpenAI from "openai";
import fs from "fs";

const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY! });

export async function carregarBaseConhecimento() {
  try {
    const path = process.env.BASE_KNOWLEDGE_PATH || "./knowledge/base_conhecimento.txt";
    return fs.existsSync(path) ? fs.readFileSync(path, "utf-8") : "";
  } catch {
    return "";
  }
}

export async function gerarRespostaIA(mensagem: string, contexto: string) {
  const prompt = `
VocÃª Ã© um assistente digital da clÃ­nica MedIntelli.
Use linguagem empÃ¡tica, tÃ©cnica e respeitosa.
Baseie-se exclusivamente na Base de Conhecimento abaixo.
Se a mensagem exigir aÃ§Ã£o, indique no JSON.

--- BASE DE CONHECIMENTO ---
${contexto}

--- MENSAGEM ---
${mensagem}

Responda com JSON estruturado assim:
{
  "resposta": "texto da resposta para o paciente",
  "acao": "agendar|cancelar|exame|informacao",
  "dados": { ... se houver ... }
}
`;
  try {
    const completion = await client.chat.completions.create({
      model: process.env.OPENAI_MODEL || "gpt-4-turbo",
      messages: [{ role: "user", content: prompt }],
      temperature: 0.4,
    });
    return completion.choices[0].message?.content || "";
  } catch {
    return '{"resposta":"Desculpe, estou indisponÃ­vel no momento."}';
  }
}

âš™ï¸ /supabase/functions/agent-ia/index.ts
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import { carregarBaseConhecimento, gerarRespostaIA } from "../../../src/lib/openai.ts";

Deno.serve(async (req) => {
  const supabase = createClient(
    Deno.env.get("SUPABASE_URL")!,
    Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
  );

  try {
    const { mensagem, paciente_id, origem } = await req.json();
    const contexto = await carregarBaseConhecimento();
    const respostaJSON = await gerarRespostaIA(mensagem, contexto);
    const result = JSON.parse(respostaJSON);

    // Grava histÃ³rico
    await supabase.from("whatsapp_messages").insert({
      paciente_id,
      origem: origem || "app",
      mensagem: result.resposta,
      tipo: "resposta",
      data_envio: new Date().toISOString(),
    });

    // Executa aÃ§Ã£o (se houver)
    if (result.acao === "agendar") {
      await supabase.from("agendamentos").insert(result.dados);
    }

    return new Response(JSON.stringify({ ok: true, resposta: result.resposta }), { status: 200 });
  } catch (e) {
    console.error("Erro no agente IA:", e);
    return new Response(JSON.stringify({ ok: false, erro: e.message }), { status: 400 });
  }
});

ğŸ“„ /knowledge/base_conhecimento.txt
BASE DE CONHECIMENTO - CLÃNICA MEDINTELLI

1. HorÃ¡rio de funcionamento: Segunda a Sexta, das 8h Ã s 18h.
2. Especialidades: Neurologia, Psiquiatria e ClÃ­nica Geral.
3. ConvÃªnios atendidos:
   âœ… UNIMED (exceto UNIMED Essencial)
   âœ… UNIMED UNIFÃCIL (primeira consulta com encaminhamento e autorizaÃ§Ã£o)
   âœ… CASSI
   âœ… CABESP
4. A IA pode orientar sobre agendamentos, cancelamentos, resultados de exames e dÃºvidas mÃ©dicas gerais.
5. Para novos pacientes, sÃ£o necessÃ¡rios: nome completo, telefone, e data de nascimento.
6. Consultas devem ser confirmadas pela equipe antes da realizaÃ§Ã£o.
7. Em caso de urgÃªncia, procurar o pronto atendimento.

ğŸ‘©â€âš•ï¸ 2ï¸âƒ£ MÃ“DULO PACIENTES â€” COMPLETO (CRUD + BUSCA + CONVÃŠNIOS)
ğŸ“‹ Funcionalidades obrigatÃ³rias:
FunÃ§Ã£o	DescriÃ§Ã£o
ğŸ” Buscar Pacientes	Campo de busca por nome, telefone, e e-mail (filtro incremental).
â• Cadastrar Novo	FormulÃ¡rio com validaÃ§Ã£o de convÃªnio e campos obrigatÃ³rios.
âœï¸ Editar	Permite alterar dados cadastrais e convÃªnio.
ğŸ—‘ï¸ Excluir	Remove o registro definitivamente (com confirmaÃ§Ã£o).
ğŸš« Ativar/Inativar	Altera flag ativo:boolean sem excluir o paciente.
ğŸ’¾ Tabela pacientes (Supabase)
alter table pacientes
  add column if not exists ativo boolean default true,
  add column if not exists convenio text check (convenio in ('UNIMED','UNIMED UNIFÃCIL','CASSI','CABESP'));

ğŸ§  ValidaÃ§Ã£o de convÃªnio no frontend
const conveniosPermitidos = [
  "UNIMED",
  "UNIMED UNIFÃCIL",
  "CASSI",
  "CABESP"
];


Ao cadastrar:

if (!conveniosPermitidos.includes(convenio)) {
  alert("ConvÃªnio nÃ£o aceito. Escolha um convÃªnio vÃ¡lido.");
  return;
}

ğŸ§© Endpoints REST (API Next)

GET /api/pacientes?search=

Busca por nome, telefone ou e-mail (like).

POST /api/pacientes

Cria paciente com ativo=true.

PUT /api/pacientes

Atualiza cadastro existente.

PATCH /api/pacientes/ativo

Alterna campo ativo.

DELETE /api/pacientes?id=

Remove paciente.

ğŸ–¥ï¸ Frontend (src/pages/pacientes/index.tsx)

Tabela com paginaÃ§Ã£o e cores:

ğŸŸ¢ ativo

ğŸ”´ inativo

BotÃµes: Editar, Inativar/Ativar, Excluir

Barra de busca em tempo real

FormulÃ¡rio modal de ediÃ§Ã£o com nome, telefone, convenio, data_nascimento, email.

ğŸ’¬ 3ï¸âƒ£ CORREÃ‡ÃƒO DO LOOPING â€” PAINEL DE MENSAGENS
PROBLEMA:

Nas abas â€œMensagens App Pacienteâ€ e â€œMensagens WhatsAppâ€, o sistema fica preso em â€œCarregando mensagens...â€.

CAUSA:

O useEffect de carregamento tem dependÃªncia circular (mensagens dentro da prÃ³pria lista de dependÃªncias) ou estÃ¡ aguardando resposta indefinidamente do Supabase.

âœ… SOLUÃ‡ÃƒO

Arquivo: src/pages/mensagens/index.tsx

useEffect(() => {
  let ativo = true;
  setLoading(true);

  const carregar = async () => {
    const { data, error } = await supabase
      .from("whatsapp_messages")
      .select("id, paciente_id, mensagem, origem, tipo, created_at")
      .order("created_at", { ascending: false })
      .limit(200);

    if (!ativo) return;
    if (error) console.error(error);
    else setMensagens(data);
    setLoading(false);
  };

  carregar();

  // AtualizaÃ§Ã£o periÃ³dica (sem loop)
  const interval = setInterval(carregar, 15000);

  return () => {
    ativo = false;
    clearInterval(interval);
  };
}, []); // âš ï¸ sem dependÃªncias


E no JSX:

{loading ? (
  <div className="p-4 text-gray-500">Carregando mensagens...</div>
) : mensagens.length ? (
  mensagens.map((m) => (
    <div key={m.id} className="border-b py-2 text-sm">
      <strong>{m.origem.toUpperCase()}</strong>: {m.mensagem}
    </div>
  ))
) : (
  <div className="p-4 text-gray-400">Nenhuma mensagem encontrada</div>
)}

ğŸ§© OTIMIZAÃ‡Ã•ES

Adicionar Ã­ndice no Supabase:

create index if not exists idx_whatsapp_created_at on whatsapp_messages(created_at desc);


Paginar resultados e usar limite mÃ¡ximo de 200 mensagens por vez.

Adicionar botÃ£o â€œRecarregarâ€.

âœ… RESULTADO FINAL ESPERADO
MÃ³dulo	Resultado
ğŸ’¬ IA	Responde automaticamente, com contexto da base de conhecimento e aÃ§Ãµes automÃ¡ticas.
ğŸ©º Pacientes	CRUD completo + convÃªnios validados + ativar/inativar.
ğŸ“± WhatsApp / App Chat	Mensagens carregam corretamente, sem looping.
ğŸ§  OpenAI	Usa modelo GPT-4-Turbo com contexto real da clÃ­nica e seguranÃ§a.
ğŸ§¾ Logs	Mensagens e respostas registradas no Supabase com origem e timestamp.