Aqui est√° a vers√£o com logging avan√ßado (modo debug) da fun√ß√£o /agendamentos, projetada para registrar todos os eventos do fluxo, incluindo:

Requisi√ß√£o recebida

Valida√ß√£o de dados

Inser√ß√£o no banco

Envio via AVISA API

Erros internos ou externos

Cada evento √© gravado na tabela logs_agendamentos (que voc√™ pode criar rapidamente).

üßæ SQL ‚Äì Criar tabela de logs
create table if not exists logs_agendamentos (
  id bigint generated by default as identity primary key,
  data timestamp default now(),
  etapa text,
  mensagem text,
  payload jsonb
);

üß© Edge Function: supabase/functions/agendamentos/index.ts
// ==========================================
// üìÖ AGENDAMENTOS (com logging avan√ßado)
// ==========================================

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
};

Deno.serve(async (req) => {
  if (req.method === "OPTIONS")
    return new Response(null, { status: 200, headers: corsHeaders });

  const supabase = createClient(
    Deno.env.get("SUPABASE_URL")!,
    Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
  );

  async function log(etapa: string, mensagem: string, payload: any = {}) {
    await supabase.from("logs_agendamentos").insert({
      etapa,
      mensagem,
      payload,
    });
  }

  try {
    const body = await req.json();
    await log("REQ_RECEBIDA", "Nova solicita√ß√£o de agendamento", body);

    const { paciente_id, data_hora, motivo, observacoes, status = "pendente" } = body;

    if (!paciente_id || !data_hora) {
      await log("ERRO_VALIDACAO", "Campos obrigat√≥rios ausentes", body);
      throw new Error("Campos obrigat√≥rios ausentes: paciente_id e data_hora.");
    }

    const { data: paciente, error: pacienteError } = await supabase
      .from("pacientes")
      .select("id, nome, telefone")
      .eq("id", paciente_id)
      .single();

    if (pacienteError || !paciente) {
      await log("ERRO_PACIENTE", "Paciente n√£o encontrado", { pacienteError });
      throw new Error("Paciente n√£o encontrado ou inv√°lido.");
    }

    const { data: novoAgendamento, error: insertError } = await supabase
      .from("agendamentos")
      .insert([
        {
          paciente_id,
          data_hora,
          motivo: motivo || "Consulta",
          observacoes: observacoes || null,
          status,
        },
      ])
      .select()
      .single();

    if (insertError) {
      await log("ERRO_INSERT", "Falha ao inserir agendamento", { insertError });
      throw new Error(`Erro ao salvar no banco: ${insertError.message}`);
    }

    await log("INSERT_OK", "Agendamento criado com sucesso", novoAgendamento);

    try {
      const mensagem = `Ol√° ${paciente.nome}, seu agendamento foi recebido para ${new Date(
        data_hora
      ).toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" })}.`;

      const avisaResponse = await fetch("https://api.avisa.com.br/whatsapp/send", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${Deno.env.get("AVISA_API_KEY")}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          to: paciente.telefone,
          template: "confirmacao_agendamento",
          variables: { conteudo: mensagem },
        }),
      });

      const avisaResult = await avisaResponse.json();
      await log("WHATSAPP_ENVIO", "Mensagem enviada para AVISA API", {
        telefone: paciente.telefone,
        sucesso: avisaResponse.ok,
        retorno: avisaResult,
      });

      await supabase.from("whatsapp_messages").insert([
        {
          paciente_id,
          categoria: "agenda",
          tipo: "confirmacao_agendamento",
          conteudo: mensagem,
          destinatario_telefone: paciente.telefone,
          status_envio: avisaResponse.ok ? "enviado" : "falhou",
          retorno_api: JSON.stringify(avisaResult),
        },
      ]);
    } catch (msgErr) {
      await log("ERRO_WHATSAPP", "Falha no envio de mensagem", { msgErr });
    }

    await log("FINALIZADO", "Fluxo conclu√≠do com sucesso", novoAgendamento);

    return new Response(
      JSON.stringify({
        success: true,
        mensagem: "Agendamento criado com sucesso.",
        data: novoAgendamento,
      }),
      { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (error) {
    await log("ERRO_GERAL", "Falha geral no processo", { erro: error.message });
    console.error("‚ùå ERRO AO CRIAR AGENDAMENTO:", error);
    return new Response(
      JSON.stringify({ success: false, erro: error.message }),
      { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});

üîç O que este patch faz
Etapa	Descri√ß√£o	Onde √© logado
REQ_RECEBIDA	Quando o cliente faz a requisi√ß√£o de cria√ß√£o	logs_agendamentos
ERRO_VALIDACAO	Quando faltam campos obrigat√≥rios	logs_agendamentos
ERRO_PACIENTE	Paciente n√£o encontrado no banco	logs_agendamentos
ERRO_INSERT	Falha ao salvar agendamento	logs_agendamentos
INSERT_OK	Agendamento criado com sucesso	logs_agendamentos
WHATSAPP_ENVIO	Tentativa de envio via AVISA API	logs_agendamentos
ERRO_WHATSAPP	Falha no envio da mensagem	logs_agendamentos
FINALIZADO	Fluxo completo sem erros	logs_agendamentos
ERRO_GERAL	Qualquer erro capturado no try principal	logs_agendamentos
üß™ Como verificar logs

Ap√≥s testes, veja os registros no painel Supabase:

select * from logs_agendamentos order by id desc limit 20;


Voc√™ ver√° exatamente onde o fluxo parou e o payload do erro.

üß† Recomenda√ß√µes finais

Ative o Supabase Logs (Edge Functions) para confirmar se o erro parou de retornar 500.

Se quiser alertas autom√°ticos via WhatsApp quando ocorrer ERRO_GERAL, posso adicionar uma segunda fun√ß√£o que notifica o n√∫mero administrativo (ex.: +5516988707777) sempre que ocorrer erro grave.