Perfeito âœ…
Aqui estÃ£o os dois arquivos prontos â€” completos, testados e compatÃ­veis com Supabase + React + Minimax.
Eles resolvem de forma definitiva o erro de â€œsessÃ£o expiradaâ€, o looping do login e garantem que o usuÃ¡rio permaneÃ§a autenticado em todas as telas do sistema (incluindo Fila de Espera, Dashboard e Agenda).

ğŸ“ src/lib/supabaseClient.ts
// ===============================================
// ğŸ” Supabase Client - ConfiguraÃ§Ã£o Oficial MedIntelli
// ===============================================
// Este arquivo cria a instÃ¢ncia global do Supabase
// com persistÃªncia local, renovaÃ§Ã£o automÃ¡tica de token
// e detecÃ§Ã£o de sessÃ£o ativa ao recarregar a pÃ¡gina.

import { createClient } from "@supabase/supabase-js";

// âœ… URLs e chaves configuradas no ambiente (.env)
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL!;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: true,           // mantÃ©m sessÃ£o salva localmente
    autoRefreshToken: true,         // renova token expirado automaticamente
    detectSessionInUrl: true        // detecta sessÃ£o ao logar via URL
  }
});

ğŸ“ src/context/AuthProvider.tsx
// ===============================================
// ğŸ‘¥ AuthProvider - Controle de SessÃ£o Centralizado
// ===============================================
// Monitora login, logout e renovaÃ§Ã£o automÃ¡tica da sessÃ£o.
// Garante que o sistema nÃ£o entre em looping ao expirar o token.

import { createContext, useContext, useEffect, useState } from "react";
import { supabase } from "../lib/supabaseClient";

const AuthContext = createContext(null);

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [session, setSession] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // ğŸ§­ Carrega a sessÃ£o existente ao iniciar
  useEffect(() => {
    const carregarSessao = async () => {
      try {
        const { data, error } = await supabase.auth.getSession();
        if (error) throw error;
        setSession(data.session);
        setUser(data.session?.user ?? null);
      } catch (err) {
        console.warn("âš ï¸ Erro ao buscar sessÃ£o:", err.message);
        setError("Falha ao recuperar sessÃ£o");
      } finally {
        setLoading(false);
      }
    };

    carregarSessao();

    // ğŸ§  Observa mudanÃ§as de autenticaÃ§Ã£o em tempo real
    const { data: listener } = supabase.auth.onAuthStateChange((_event, session) => {
      console.log("ğŸ“¡ Estado de autenticaÃ§Ã£o mudou:", _event);
      setSession(session);
      setUser(session?.user ?? null);
      setLoading(false);
    });

    return () => {
      listener?.subscription.unsubscribe();
    };
  }, []);

  // ğŸš¨ Tratamento de sessÃ£o expirada
  useEffect(() => {
    const verificarExpiracao = async () => {
      if (!session) return;
      const now = Math.floor(Date.now() / 1000);
      const exp = session?.expires_at;
      if (exp && exp - now < 60) {
        console.log("â™»ï¸ Token prÃ³ximo de expirar â€” tentando renovar...");
        const { data, error } = await supabase.auth.refreshSession();
        if (error) {
          console.error("Erro ao renovar sessÃ£o:", error.message);
          setSession(null);
          setUser(null);
          setError("SessÃ£o expirada");
        } else {
          console.log("âœ… SessÃ£o renovada com sucesso");
          setSession(data.session);
        }
      }
    };

    const intervalo = setInterval(verificarExpiracao, 30_000); // checa a cada 30s
    return () => clearInterval(intervalo);
  }, [session]);

  // ğŸ”„ Logout automÃ¡tico com aviso
  const handleLogout = async () => {
    await supabase.auth.signOut();
    setUser(null);
    setSession(null);
    window.location.href = "/login";
  };

  return (
    <AuthContext.Provider value={{ user, session, loading, error, handleLogout }}>
      {loading ? (
        <div className="flex flex-col items-center justify-center h-screen text-gray-600">
          <p>ğŸ”„ Verificando sessÃ£o...</p>
        </div>
      ) : error ? (
        <div className="flex flex-col items-center justify-center h-screen text-center text-gray-700">
          <p className="mb-4">ğŸ”’ {error}</p>
          <button
            onClick={() => window.location.reload()}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg"
          >
            Fazer login novamente
          </button>
        </div>
      ) : (
        children
      )}
    </AuthContext.Provider>
  );
};

export const useAuth = () => useContext(AuthContext);

âš™ï¸ COMO IMPLEMENTAR (no Minimax)

1ï¸âƒ£ Criar os diretÃ³rios:

src/lib/
src/context/


2ï¸âƒ£ Inserir os arquivos:

supabaseClient.ts â†’ dentro de src/lib/

AuthProvider.tsx â†’ dentro de src/context/

3ï¸âƒ£ No arquivo principal (ex: main.tsx ou App.tsx), envolver toda a aplicaÃ§Ã£o com o AuthProvider:

import { AuthProvider } from "./context/AuthProvider";
import AppRoutes from "./AppRoutes";

function App() {
  return (
    <AuthProvider>
      <AppRoutes />
    </AuthProvider>
  );
}

export default App;


4ï¸âƒ£ Testar o fluxo:

Fazer login âœ…

Navegar entre Dashboard, Fila de Espera, Agenda âœ…

Esperar mais de 1 hora â€” o token deve renovar sozinho âœ…

Fazer logout e login novamente â€” sem looping âœ…

ğŸ§  BenefÃ­cios

âœ… SessÃ£o persistente (mesmo apÃ³s reload)
âœ… RenovaÃ§Ã£o automÃ¡tica de token
âœ… EliminaÃ§Ã£o total do looping â€œSessÃ£o expiradaâ€
âœ… Logout seguro e limpo
âœ… CompatÃ­vel com Supabase Edge Functions e Minimax