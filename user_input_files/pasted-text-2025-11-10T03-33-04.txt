vamos travar um ‚Äúmodo execu√ß√£o sem erro‚Äù no MiniMax. Abaixo est√° um roteiro √∫nico para colar no MiniMax (uma tarefa s√≥) que ele deve seguir rigidamente, sem parar, sem mocks, sem dados fict√≠cios, usando apenas o telefone de teste +55 16 98870-7777 durante todo o desenvolvimento autom√°tico.
Inclui: esquema do banco, pol√≠ticas RLS, endpoints/edge functions, regras do agente de IA com Base √önica de Conhecimento, integra√ß√£o WhatsApp (Avisa API), calend√°rio estilo Google, fila de espera, dashboards e seed de usu√°rios com perfis.

Partes de WhatsApp (tabelas, fun√ß√µes, webhooks, centro de mensagens, fluxos de confirma√ß√£o) referenciam a documenta√ß√£o anexa e devem ser seguidas ao p√© da letra. 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

üì¶ Especifica√ß√£o de Implementa√ß√£o ‚Äî ‚ÄúSEM ERROS & SEM MOCKS‚Äù
0) Regras Globais (obrigat√≥rias)

Proibir mocks/dados fict√≠cios: qualquer tentativa de enviar mensagem fora do n√∫mero de teste deve falhar bloqueando a a√ß√£o com erro vis√≠vel:

Em DEV/AUTOM√ÅTICO: SOMENTE +5516988707777.

Em PROD: liberar lista branca via tabela whatsapp_config (chave allowlist_telefones). 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

Bot√µes nunca sem a√ß√£o:

Antes de renderizar qualquer bot√£o, o MiniMax deve verificar se o handler existe; caso n√£o exista, n√£o renderizar o bot√£o.

Cada bot√£o chama uma fun√ß√£o de servi√ßo que bate em uma rota/edge function v√°lida e retorna ok | erro.

Fonte √∫nica de verdade para Agendamentos: uma tabela agendamentos abastece Agenda do Sistema Principal e APP Paciente.

Base √önica de Conhecimento (BUC): um arquivo corrente, armazenado na tabela knowledge_store (colunas id, version, content, active), lido pelo Agente de IA em todas as decis√µes/rea√ß√µes (chat, WhatsApp, rotas autom√°ticas).

Timezone: America/Sao_Paulo em todas as consultas/normaliza√ß√µes de data.

Sem parada: MiniMax deve executar toda a fila de tarefas at√© passar em todos os testes de aceite ao final (lista no item 10).

Observabilidade obrigat√≥ria: log estruturado (requestId, rota, payload sanitizado, resultado, tempo) em todas as Edge Functions.

1) Vari√°veis de Ambiente e Build
SUPABASE_URL=...
SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...

OPENAI_API_KEY=...

AVISA_API_URL=https://api.avisa.com.br
AVISA_API_KEY=...
WHATSAPP_WEBHOOK_SECRET=...

APP_ENV=dev
TZ=America/Sao_Paulo


Regra dev (gating de telefone):

Se APP_ENV=dev, validar que telefone === +5516988707777 antes de qualquer envio WhatsApp; sen√£o 400 com mensagem ‚ÄúTelefone n√£o autorizado em modo DEV‚Äù.

2) Banco de Dados (Supabase / Postgres)
2.1 Tabelas n√∫cleo
-- Usu√°rios (Auth nativo do Supabase) + Perfil
create table if not exists user_profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  nome text not null,
  perfil text not null check (perfil in ('SUPERADMIN','ADMIN','Medico','Secretaria','Auxiliar')),
  created_at timestamptz default now()
);

-- Pacientes
create table if not exists pacientes (
  id uuid primary key default gen_random_uuid(),
  nome text not null,
  data_nascimento date,
  email text,
  telefone text,              -- E.164 preferencial
  telefone_alt text,
  convenio text,
  endereco text,
  contato_nome text,
  created_at timestamptz default now()
);

-- Agenda (fonte √∫nica)
create table if not exists agendamentos (
  id uuid primary key default gen_random_uuid(),
  paciente_id uuid references pacientes(id),
  inicio timestamptz not null,
  fim timestamptz not null,
  status text not null check (status in ('pendente','confirmado','cancelado','atrasado','em_atendimento')),
  origem text not null check (origem in ('app','manual','whatsapp','ia')),
  observacoes text,
  created_by uuid references auth.users(id),
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- Lista de Espera
create table if not exists fila_espera (
  id uuid primary key default gen_random_uuid(),
  paciente_id uuid references pacientes(id),
  motivo text,
  prioridade text check (prioridade in ('baixa','media','alta','urgente')) default 'media',
  status text check (status in ('ativo','atendido','removido')) default 'ativo',
  created_at timestamptz default now()
);

-- Feriados (com RLS correta para insert manual)
create table if not exists feriados (
  id uuid primary key default gen_random_uuid(),
  data date not null,
  titulo text not null,
  escopo text not null check (escopo in ('nacional','municipal')),
  municipio text,
  uf char(2),
  created_by uuid references auth.users(id),
  created_at timestamptz default now()
);

-- WhatsApp (estrutura conforme doc)
create table if not exists whatsapp_messages (
  id uuid primary key default gen_random_uuid(),
  paciente_id uuid references pacientes(id),
  categoria text not null,    -- agenda/paciente/financeiro/saude/marketing
  tipo text not null,         -- confirmacao_agendamento, etc.
  conteudo text not null,
  template_id text,
  destinatario_telefone text not null,
  status_envio text default 'pendente', -- pendente/enviado/entregue/lido/falhou
  mensagem_origem text default 'sistema', -- sistema/manual/automatica
  data_agendamento timestamptz,
  avisa_message_id text,      -- se houver
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table if not exists whatsapp_templates (
  id uuid primary key default gen_random_uuid(),
  nome text not null,
  categoria text not null,
  tipo text not null,
  conteudo_template text not null,
  variaveis jsonb,
  ativo boolean default true,
  created_at timestamptz default now()
);

create table if not exists whatsapp_config (
  id uuid primary key default gen_random_uuid(),
  chave text unique not null,
  valor text not null,
  descricao text,
  updated_at timestamptz default now()
);

-- Base √önica de Conhecimento
create table if not exists knowledge_store (
  id uuid primary key default gen_random_uuid(),
  version int not null,
  content text not null,    -- conte√∫do inteiro (1 arquivo corrente)
  active boolean default false,
  created_at timestamptz default now()
);


As tabelas WhatsApp acima est√£o alinhadas ao documento t√©cnico anexado e devem ser usadas exatamente (campos/tipos podem ser mantidos como especificados). 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

2.2 RLS
-- Habilitar RLS nas tabelas de dom√≠nio
alter table user_profiles enable row level security;
alter table pacientes enable row level security;
alter table agendamentos enable row level security;
alter table fila_espera enable row level security;
alter table feriados enable row level security;
alter table whatsapp_messages enable row level security;
alter table whatsapp_templates enable row level security;
alter table whatsapp_config enable row level security;
alter table knowledge_store enable row level security;

-- Pol√≠ticas simples (pode granularizar por tenant se necess√°rio)
create policy p_select_all_authenticated on pacientes for select to authenticated using (true);
create policy p_ins_upd_pacientes on pacientes for all to authenticated using (true) with check (true);

create policy p_ag_select on agendamentos for select to authenticated using (true);
create policy p_ag_insert on agendamentos for insert to authenticated with check (true);
create policy p_ag_update on agendamentos for update to authenticated using (true) with check (true);

create policy p_fila_select on fila_espera for select to authenticated using (true);
create policy p_fila_write on fila_espera for insert to authenticated with check (true);
create policy p_fila_update on fila_espera for update to authenticated using (true) with check (true);

-- Feriados: quem insere deve ser o criador
create policy feriados_read on feriados for select to authenticated using (true);
create policy feriados_insert on feriados for insert to authenticated with check (auth.uid() = created_by);
create policy feriados_update on feriados for update to authenticated using (auth.uid() = created_by) with check (auth.uid() = created_by);

3) Seeds (SUPERADMIN + usu√°rios solicitados)

Criar via Edge Function seed-users usando SERVICE_ROLE para auth.admin.createUser() e depois inserir em user_profiles. Perfis:

SUPERADMIN: tudo liberado

ADMIN

Medico

Secretaria

Auxiliar

Emails e senhas a semear:

Silvia ‚Äì silvia@medintelli.com.br / senha123 ‚Äì ADMIN

Gabriel ‚Äì gabriel@medintelli.com.br / senha123 ‚Äì Auxiliar

Natashia ‚Äì natashia@medintelli.com.br / senha123 ‚Äì Secretaria

Dr. Francisco ‚Äì drfrancisco@medintelli.com.br / senha123 ‚Äì Medico

Al√©m disso, crie um SUPERADMIN (seu email) com senha forte.

4) Edge Functions (Supabase)
4.1 /functions/agendamentos (√∫nica fonte de cria√ß√£o/atualiza√ß√£o)

POST criar agendamento; valida conflito (inicio ‚â§ fim, e overlap com outro n√£o cancelado)

PUT atualizar status/reagendar

Em sucesso, dispara:

Realtime para atualizar a UI da Agenda

Automa√ß√£o de confirma√ß√£o via WhatsApp (se configurado) ‚Äî ver doc. 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

4.2 /functions/fila-espera

POST inserir na fila

GET listar (status=ativo por padr√£o)

4.3 /functions/feriados-sync

Buscar feriados autom√°ticos (usar OpenAI/KB para montar lista se necess√°rio) e upsert em feriados (evitar duplicidade).

POST feriados manual: exige created_by = auth.uid() para respeitar RLS.

4.4 WhatsApp (Avisa API) ‚Äî seguir a doc anexa

whatsapp-send-message: valida√ß√£o de telefone (dev gating), envio via Avisa, registrar em whatsapp_messages e status enviado. 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

whatsapp-webhook-receiver: validar WHATSAPP_WEBHOOK_SECRET, processar event_type/status/contact_phone/message_id, atualizar whatsapp_messages.status_envio, vincular a agendamento_id quando for confirma√ß√£o. 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

whatsapp-scheduler: lembretes/confirmadores autom√°ticos conforme whatsapp_config. 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

5) API Routes (se usar Next.js API junto das functions)

/api/agendamentos ‚Üí proxy para functions/agendamentos

/api/fila-espera ‚Üí proxy para functions/fila-espera

/api/feriados ‚Üí proxy para functions/feriados-sync

/api/whatsapp-send-message ‚Üí proxy para functions/whatsapp-send-message

/api/whatsapp-webhook ‚Üí p√∫blico (POST) ‚Üí functions/whatsapp-webhook-receiver

Sempre retornar { ok:true, data } ou { error: 'mensagem' } com HTTP adequado.

6) Base √önica de Conhecimento (BUC)

Tabela knowledge_store com 1 registro active=true.

O Agente de IA l√™ content a cada solicita√ß√£o (cache local com invalida√ß√£o por version).

Toda inten√ß√£o (agendar, cancelar, tirar d√∫vidas, exames, receitu√°rio) primeiro passa no extrator de inten√ß√£o (OpenAI) alimentado pela BUC, depois chama as rotas reais (/agendamentos, /whatsapp-send-message, etc.).

Proibido responder sem tentar a a√ß√£o quando inten√ß√£o exigir (ex.: ‚Äúquero agendar amanh√£‚Äù). Se faltar dado (hor√°rio, especialidade), o Agente pergunta e finaliza a a√ß√£o.

7) Frontend ‚Äî Sistema Principal (link 1)
7.1 Agenda estilo Google (mensal, semanal, di√°ria)

Modo mensal/semanal: badge com contagem por dia via RPC:

create or replace function public.agenda_contagem_por_dia(_inicio timestamptz, _fim timestamptz)
returns table(dia date, total bigint)
language sql stable as $$
  select (a.inicio at time zone 'America/Sao_Paulo')::date as dia,
         count(*) as total
  from agendamentos a
  where a.inicio >= _inicio and a.inicio < _fim
    and a.status <> 'cancelado'
  group by 1
  order by 1;
$$;


Ao clicar no dia, abrir lista com todos hor√°rios e agendamentos (nome do paciente, status, origem, a√ß√µes r√°pidas confirmar/cancelar/reagendar).

Realtime: subscrever agendamentos para atualizar imediatamente.

7.2 Fila de Espera

Formul√°rio POST /fila-espera ‚Üí ao salvar, refetch e renderizar o novo item no topo.

Incluir bot√£o ‚ÄúVoltar‚Äù no topo da p√°gina.

7.3 Usu√°rios

Criar/Editar obrigatoriamente com feedback visual (loading, success, error). Nunca renderizar bot√£o sem handler atrelado.

7.4 Dashboard de Conversas

Componente WhatsAppMessageCenter (da doc) para listar, filtrar por categoria/tipo/paciente, enviar mensagem (em dev, s√≥ n√∫mero teste). 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

Encaminhar ao m√©dico: bot√£o que marca destino='medico' e cria alerta em ‚ÄúDashboard M√©dico‚Äù.

7.5 Dashboard M√©dico (alertas)

Caixas ‚ÄúNovas conversas relevantes‚Äù e ‚ÄúExames recebidos‚Äù (ver item 9).

Se m√©dico n√£o responder em X minutos (config em whatsapp_config), alerta vis√≠vel para Secretaria/Auxiliar ‚Äúreenviar/lembrar m√©dico‚Äù.

8) Frontend ‚Äî APP Paciente (link 2)

Chat IA (usa BUC) + hist√≥rico l√° e refletindo no Principal (via rotas √∫nicas).

Agendamento: ao confirmar no chat ou no formul√°rio, chama /agendamentos (POST); resultado atualiza hist√≥rico e a Agenda do Principal (Realtime).

N√£o exibir agendamentos de outras pessoas (scopo por paciente).

9) Fluxos de Automa√ß√£o (resumo obrigat√≥rio)

Paciente (WhatsApp ou APP) pede consulta ‚Üí Classificador (BUC + OpenAI) identifica AGENDA/agendamento_consulta ‚Üí obt√©m disponibilidade ‚Üí confirma hor√°rio ‚Üí POST /agendamentos ‚Üí envia confirma√ß√£o via WhatsApp (template) ‚Üí aparece no APP e no Principal. 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

Cancelamento/Reagendamento idem, acionando PUT /agendamentos com status/novo hor√°rio.

Lembretes: whatsapp-scheduler agenda lembretes conforme whatsapp_config (hor√°rio/limite di√°rio). 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

Exames: upload no APP/WhatsApp ‚Üí classificar como SAUDE/resultado_exames ‚Üí enviar para Dashboard M√©dico com alerta; se n√£o respondido em N minutos, alerta Secretaria/Auxiliar para intervir.

10) Testes de Aceite (DEV deve passar 100%)

API (vitest/jest/supertest):

Usu√°rios: criar/editar, sem erro de RLS.

Agendamentos: criar (sem conflito), conflito retorna 409, atualizar status, refletir no GET.

Fila de Espera: inserir e listar.

Feriados: buscar autom√°ticos preenche; inserir manual n√£o quebra RLS (com created_by).

WhatsApp:

Envio bloqueia qualquer telefone ‚â† +5516988707777 em APP_ENV=dev.

Envio para +5516988707777 grava em whatsapp_messages status_envio='enviado'.

Webhook atualiza status_envio e vincula confirma√ß√£o ao agendamento. 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

UI (Playwright):

Agenda mensal/semanal mostra contagem por dia; ao clicar, lista hor√°rios e mostra o agendamento rec√©m-criado (manual e via APP).

APP Paciente: ao agendar pelo chat, aparece no Principal imediatamente (Realtime).

Fila de Espera: salvar ‚Üí aparece na lista; bot√£o Voltar funciona.

WhatsApp Dashboard: lista hist√≥rico, envia mensagem (dev gating ativo).

Defini√ß√£o de Pronto (DoD): todos os testes acima PASS; nenhuma console error; nenhuma rota 4xx/5xx durante os flows b√°sicos.

11) Passos de Deploy & CI/CD
# 1) Migrations e RLS
supabase db push

# 2) Deploy Edge Functions
supabase functions deploy agendamentos
supabase functions deploy fila-espera
supabase functions deploy feriados-sync
supabase functions deploy whatsapp-send-message
supabase functions deploy whatsapp-webhook-receiver
supabase functions deploy whatsapp-scheduler
# (ver doc) :contentReference[oaicite:14]{index=14}

# 3) Seeds
supabase functions deploy seed-users
# chame a seed (ou rode script local) para criar SUPERADMIN e usu√°rios solicitados


Pipeline: rodar testes API + UI; se falhar, n√£o publicar.

12) Pap√©is & Permiss√µes (o que cada um v√™)

SUPERADMIN: todas as fun√ß√µes (usu√°rios, perfis, agendamentos, fila, feriados, dashboards, WhatsApp, BUC, configs).

ADMIN: tudo exceto BUC e configs sens√≠veis.

Medico: Dashboard M√©dico (conversas relevantes, exames, agenda pessoal), confirmar/cancelar slots; n√£o pode alterar usu√°rios.

Secretaria: agenda completa, fila de espera, feriados, WhatsApp message center, reenvio/alertas ao m√©dico.

Auxiliar: apoio em fila/whatsapp, leitura de agenda, sem acesso a usu√°rios/perfis.

13) UI/UX ‚Äì Regras de Navegabilidade

Header com links: Agenda, Fila de Espera, Pacientes, Conversas/WhatsApp, Feriados, Usu√°rios (se permitido), Dashboard M√©dico (se perfil).

Em Fila de Espera, incluir ‚ÄúVoltar‚Äù e breadcrumbs.

Em Agenda, uso de cores:

Atrasado (vermelho), Em atendimento (ambar), Confirmado (verde), Pendente (cinza).

Em WhatsApp Dashboard, filtros por categoria/tipo/status, bot√£o ‚ÄúEncaminhar ao M√©dico‚Äù.

Mensagem final para o MiniMax (cole no topo da tarefa)

INSTRU√á√ÉO OBRIGAT√ìRIA:

Execute TUDO exatamente como especificado acima, sem parar, sem mocks e usando exclusivamente o telefone +55 16 98870-7777 em APP_ENV=dev.

N√£o renderize nenhum bot√£o sem handler v√°lido conectado a uma rota/edge function funcional.

Use uma tabela √∫nica agendamentos para abastecer Agenda do Principal e APP Paciente.

A Base √önica de Conhecimento deve ser 1 arquivo corrente em knowledge_store (active=true) e usada em todas as decis√µes do Agente de IA.

Integra√ß√£o WhatsApp/Avisa deve seguir o documento anexo (envio, webhook, scheduler, UI de mensagens, templates, categorias/tipos). 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

 

DOCUMENTACAO_TECNICA_WHATSAPP_A‚Ä¶

Publique dois links ao final: Sistema Principal e APP Paciente.

S√≥ finalize quando TODOS os testes de aceite (item 10) estiverem 100% PASS.